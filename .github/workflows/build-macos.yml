name: Build macOS Application

on:
  workflow_dispatch:  # MANUAL TRIGGER ONLY - You click a button, no auto-runs
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-macos:
    # Build universal2 binary (Intel + Apple Silicon) using Python.org's universal2 Python
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Python.org universal2 Python
      run: |
        echo "ğŸ“¦ Downloading Python.org universal2 Python installer..."
        curl -o python-installer.pkg https://www.python.org/ftp/python/3.11.7/python-3.11.7-macos11.pkg
        
        echo "ğŸ”§ Installing Python..."
        sudo installer -pkg python-installer.pkg -target /
        
        # Use the Python.org Python (not system Python)
        export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH"
        
        echo "âœ… Python installed:"
        python3.11 --version
        
        # Verify it's universal2
        echo "ğŸ” Verifying Python is universal2..."
        lipo -info /Library/Frameworks/Python.framework/Versions/3.11/Python
        
        if lipo -info /Library/Frameworks/Python.framework/Versions/3.11/Python | grep -q "x86_64" && lipo -info /Library/Frameworks/Python.framework/Versions/3.11/Python | grep -q "arm64"; then
          echo "âœ… Python is universal2 (x86_64 + arm64)"
        else
          echo "âŒ ERROR: Python is not universal2!"
          exit 1
        fi
    
    - name: Install dependencies
      run: |
        # Use Python.org Python
        export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH"
        
        echo "ğŸ“¦ Installing pip packages..."
        python3.11 -m pip install --upgrade pip
        python3.11 -m pip install -r requirements.txt
        python3.11 -m pip install pyinstaller
        
        echo "âœ… Dependencies installed"
    
    - name: Build macOS universal2 app
      run: |
        # Use Python.org Python
        export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH"
        
        echo "ğŸ”¨ Building universal2 app with PyInstaller..."
        python3.11 -m PyInstaller --name="ArgoLogViewer" \
          --windowed \
          --onefile \
          --add-data="app:app" \
          --hidden-import=PySide6 \
          --hidden-import=paramiko \
          --hidden-import=cryptography \
          --clean \
          --osx-bundle-identifier=com.harshmeetsingh.argologviewer \
          --target-arch universal2 \
          app/main.py
    
    - name: Verify universal2 binary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” VERIFYING UNIVERSAL2 BINARY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Find the main executable inside the .app bundle
        EXECUTABLE="dist/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer"
        
        if [ ! -f "$EXECUTABLE" ]; then
          echo "âŒ ERROR: Executable not found at $EXECUTABLE"
          exit 1
        fi
        
        echo "ğŸ“¦ Checking architectures in executable:"
        lipo -info "$EXECUTABLE"
        file "$EXECUTABLE"
        echo ""
        
        # Verify it contains both architectures
        if lipo -info "$EXECUTABLE" | grep -q "x86_64" && lipo -info "$EXECUTABLE" | grep -q "arm64"; then
          echo "âœ… SUCCESS: Binary is universal2!"
          echo "   âœ“ Contains x86_64 (Intel)"
          echo "   âœ“ Contains arm64 (Apple Silicon)"
          echo ""
          echo "âœ… Will run natively on both Intel and Apple Silicon Macs"
          echo "âœ… NO Rosetta 2 required!"
        else
          echo "âŒ ERROR: Binary is not universal2!"
          echo "Expected: x86_64 and arm64"
          echo "Got:"
          lipo -info "$EXECUTABLE"
          exit 1
        fi
        
        echo ""
        echo "ğŸ“‹ Executable info:"
        ls -lh "$EXECUTABLE"
        echo ""
        echo "ğŸ“ App bundle contents:"
        ls -la dist/ArgoLogViewer.app/Contents/
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Create DMG installer
      run: |
        mkdir -p dist/dmg
        cp -r dist/ArgoLogViewer.app dist/dmg/
        ln -s /Applications dist/dmg/Applications
        hdiutil create -volname "Argo Log Viewer" \
          -srcfolder dist/dmg \
          -ov -format UDZO \
          "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg"
        rm -rf dist/dmg
    
    - name: Zip the .app for direct download
      run: |
        cd dist
        zip -r ../ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip ArgoLogViewer.app
        cd ..
    
    - name: Generate checksums
      run: |
        shasum -a 256 ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg > checksums.txt
        shasum -a 256 ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip >> checksums.txt
        cat checksums.txt
    
    - name: Upload artifacts (backup)
      uses: actions/upload-artifact@v4
      with:
        name: ArgoLogViewer-macOS-v${{ github.event.inputs.version }}
        path: |
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip
          checksums.txt
        retention-days: 90
    
    - name: Create GitHub Release
      if: github.event.inputs.create_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Argo Log Viewer v${{ github.event.inputs.version }} (macOS)
        body: |
          ## ğŸ macOS Release v${{ github.event.inputs.version }}
          
          ### ğŸ“¥ Downloads
          
          Choose one:
          - **ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg** - Recommended installer (drag-to-install)
          - **ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip** - Portable app bundle
          
          ### ğŸ“‹ Installation
          
          **DMG Method (Recommended):**
          1. Download the .dmg file
          2. Open it
          3. Drag "ArgoLogViewer" to Applications folder
          4. Eject the DMG
          5. Right-click app â†’ Open (first time only, to bypass Gatekeeper)
          
          **ZIP Method:**
          1. Download and unzip
          2. Move ArgoLogViewer.app to Applications
          3. Right-click app â†’ Open (first time only)
          
          ### âœ… Checksums
          See `checksums.txt` for SHA-256 verification
          
          ### ğŸ› Issues?
          Report at: https://github.com/${{ github.repository }}/issues
        draft: false
        prerelease: false
        files: |
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip
          checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Final verification and build info
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… BUILD COMPLETE - UNIVERSAL2 BINARY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Version: v${{ github.event.inputs.version }}"
        echo ""
        
        # Verify the final DMG contains universal2
        echo "ğŸ” Final verification of DMG contents..."
        hdiutil attach "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg" -mountpoint /tmp/verify_dmg
        
        DMG_EXECUTABLE="/tmp/verify_dmg/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer"
        if [ -f "$DMG_EXECUTABLE" ]; then
          echo "âœ… DMG mounted successfully"
          echo "ğŸ“‹ Architecture check:"
          lipo -info "$DMG_EXECUTABLE"
          
          if lipo -info "$DMG_EXECUTABLE" | grep -q "x86_64" && lipo -info "$DMG_EXECUTABLE" | grep -q "arm64"; then
            echo "âœ… DMG contains universal2 binary (x86_64 + arm64)"
            echo "âœ… ONE-CLICK INSTALL - NO ROSETTA 2 REQUIRED!"
          else
            echo "âŒ ERROR: DMG does not contain universal2 binary!"
            exit 1
          fi
        else
          echo "âŒ ERROR: Could not verify DMG contents"
          exit 1
        fi
        
        hdiutil detach /tmp/verify_dmg || true
        echo ""
        
        # File sizes
        if [ -f "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg" ]; then
          echo "ğŸ’¾ DMG size: $(du -sh ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg | cut -f1)"
        fi
        if [ -f "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip" ]; then
          echo "ğŸ’¾ ZIP size: $(du -sh ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip | cut -f1)"
        fi
        echo ""
        
        # Release info
        if [ "${{ github.event.inputs.create_release }}" == "true" ]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ RELEASE PUBLISHED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”— Release URL:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
          echo ""
          echo "ğŸ“¥ Download URL:"
          echo "   https://github.com/${{ github.repository }}/releases/latest"
          echo ""
          echo "âœ… TRUE UNIVERSAL2 BINARY:"
          echo "   âœ“ Intel Macs (x86_64) - Native performance"
          echo "   âœ“ Apple Silicon Macs (arm64) - Native performance"
          echo "   âœ“ ONE-CLICK install, NO Rosetta 2 prompt"
          echo ""
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"