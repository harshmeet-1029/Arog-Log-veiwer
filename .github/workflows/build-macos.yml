name: Build macOS Application

on:
  workflow_dispatch:  # MANUAL TRIGGER ONLY - You click a button, no auto-runs
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-macos-arm:
    # Build Apple Silicon (arm64) binary
    runs-on: macos-latest  # Apple Silicon runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing pip packages for Apple Silicon build..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        echo "‚úÖ Dependencies installed"
    
    - name: Create macOS icon (.icns)
      run: |
        echo "üé® Creating .icns icon for macOS..."
        mkdir -p app/icon.iconset
        sips -z 16 16 app/ICON.png --out app/icon.iconset/icon_16x16.png
        sips -z 32 32 app/ICON.png --out app/icon.iconset/icon_16x16@2x.png
        sips -z 32 32 app/ICON.png --out app/icon.iconset/icon_32x32.png
        sips -z 64 64 app/ICON.png --out app/icon.iconset/icon_32x32@2x.png
        sips -z 128 128 app/ICON.png --out app/icon.iconset/icon_128x128.png
        sips -z 256 256 app/ICON.png --out app/icon.iconset/icon_128x128@2x.png
        sips -z 256 256 app/ICON.png --out app/icon.iconset/icon_256x256.png
        sips -z 512 512 app/ICON.png --out app/icon.iconset/icon_256x256@2x.png
        sips -z 512 512 app/ICON.png --out app/icon.iconset/icon_512x512.png
        sips -z 1024 1024 app/ICON.png --out app/icon.iconset/icon_512x512@2x.png
        iconutil -c icns app/icon.iconset -o app/icon.icns
        rm -rf app/icon.iconset
        echo "‚úÖ Icon created: app/icon.icns"
    
    - name: Build macOS Apple Silicon app
      run: |
        export MACOSX_DEPLOYMENT_TARGET=11.0
        
        echo "üî® Building Apple Silicon (arm64) app with PyInstaller..."
        echo "üìã Deployment target: macOS 11.0 Big Sur and later (including Sonoma)"
        python -m PyInstaller --name="ArgoLogViewer" \
          --windowed \
          --onedir \
          --icon="app/icon.icns" \
          --add-data="app:app" \
          --hidden-import=PySide6 \
          --hidden-import=paramiko \
          --hidden-import=cryptography \
          --clean \
          --osx-bundle-identifier=com.harshmeetsingh.argologviewer \
          --target-arch arm64 \
          --codesign-identity - \
          app/main.py
        
        echo ""
        echo "üîß Fixing code signatures for distribution..."
        
        # Remove all code signatures to prevent Team ID mismatches
        sudo codesign --remove-signature dist/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer 2>/dev/null || true
        
        # Re-sign with consistent ad-hoc signature (deep sign everything)
        sudo codesign -s - --deep --force dist/ArgoLogViewer.app
        
        echo "‚úÖ Code signatures fixed"
    
    - name: Verify Apple Silicon binary
      run: |
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üîç VERIFYING APPLE SILICON BINARY"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        
        EXECUTABLE="dist/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer"
        
        if [ ! -f "$EXECUTABLE" ]; then
          echo "‚ùå ERROR: Executable not found at $EXECUTABLE"
          exit 1
        fi
        
        echo "üì¶ Checking architecture in executable:"
        lipo -info "$EXECUTABLE"
        file "$EXECUTABLE"
        echo ""
        
        if lipo -info "$EXECUTABLE" | grep -q "arm64"; then
          echo "‚úÖ SUCCESS: Binary is Apple Silicon arm64!"
          echo "   ‚úì Native Apple Silicon support (M1, M2, M3, M4)"
          echo "   ‚úì Compatible with macOS 11.0+ (Big Sur, Monterey, Ventura, Sonoma)"
          echo "   ‚úì Maximum performance on Apple Silicon Macs"
        else
          echo "‚ùå ERROR: Binary is not arm64!"
          exit 1
        fi
        
        echo ""
        echo "üìã Executable info:"
        ls -lh "$EXECUTABLE"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    - name: Create Apple Silicon DMG installer
      run: |
        mkdir -p dist/dmg
        cp -r dist/ArgoLogViewer.app dist/dmg/
        ln -s /Applications dist/dmg/Applications
        hdiutil create -volname "Argo Log Viewer (Apple Silicon)" \
          -srcfolder dist/dmg \
          -ov -format UDZO \
          "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.dmg"
        rm -rf dist/dmg
    
    - name: Zip the Apple Silicon .app
      run: |
        cd dist
        zip -r ../ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.zip ArgoLogViewer.app
        cd ..
    
    - name: Generate Apple Silicon checksums
      run: |
        shasum -a 256 ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.dmg > checksums-arm.txt
        shasum -a 256 ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.zip >> checksums-arm.txt
        cat checksums-arm.txt
    
    - name: Upload Apple Silicon artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ArgoLogViewer-macOS-AppleSilicon-v${{ github.event.inputs.version }}
        path: |
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.dmg
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.zip
          checksums-arm.txt
        retention-days: 90

  create-release:
    needs: [build-macos-arm]
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create checksums file
      run: |
        cat ArgoLogViewer-macOS-AppleSilicon-v${{ github.event.inputs.version }}/checksums-arm.txt > CHECKSUMS.txt
        echo "=== CHECKSUMS ==="
        cat CHECKSUMS.txt
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Argo Log Viewer v${{ github.event.inputs.version }} (macOS)
        body: |
          ## üçé macOS Release v${{ github.event.inputs.version }}
          
          ### ‚ö†Ô∏è IMPORTANT: macOS Security Notice
          
          **This application is NOT code-signed or notarized by Apple.** When you first open it, macOS Gatekeeper will block it with this error:
          
          > "ArgoLogViewer" can't be opened because Apple cannot check it for malicious software.
          
          **This is normal and expected.** The app is safe, but requires extra steps to open. Follow the instructions below.
          
          ---
          
          ### üì• Downloads
          
          | Mac Type | Download (DMG) | Download (ZIP) |
          |----------|----------------|----------------|
          | üöÄ **Apple Silicon (M1/M2/M3/M4)** | [macOS-AppleSilicon.dmg](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.dmg) | [macOS-AppleSilicon.zip](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.zip) |
          | üíª **Intel Macs** | [macOS-Intel.dmg](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-Intel.dmg) | [macOS-Intel.zip](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-Intel.zip) |
          
          > **Note for Intel Mac users:** Intel builds are uploaded manually. If not available yet, please check back shortly or download the Apple Silicon version (works via Rosetta 2).
          
          **Not sure which Mac you have?**
          - Click the Apple menu () ‚Üí "About This Mac"
          - **Intel Macs:** Shows "Processor: Intel Core i5/i7/i9"
          - **Apple Silicon:** Shows "Chip: Apple M1/M2/M3/M4"
          
          ---
          
          ### üîì HOW TO INSTALL & BYPASS SECURITY WARNING
          
          #### ‚≠ê Method 1: System Settings (RECOMMENDED - Works on ALL macOS versions)
          
          This is the **EASIEST** method, especially for **macOS Sequoia (15.x), Sonoma (14.x), and Ventura (13.x)**.
          
          **Steps:**
          1. **Download** the correct DMG file for your Mac type (see table above)
          2. **Open** the DMG and **drag ArgoLogViewer to Applications**
          3. **Try to open** the app (double-click it in Applications)
             - You'll see an error: *"ArgoLogViewer" can't be opened...* ‚Üí Click **"Done"**
          4. **Open System Settings** ‚Üí **Privacy & Security**
          5. **Scroll down** to the **Security** section
          6. Look for: **"ArgoLogViewer" was blocked to protect your Mac**
          7. Click the **"Open Anyway"** button next to it
          8. **Confirm** by clicking **"Open"** in the dialog
          9. ‚úÖ **Done!** The app will now open normally forever!
          
          **üì∏ See screenshots in the full guide:** [MACOS_INSTALLATION.md](../../blob/main/MACOS_INSTALLATION.md)
          
          ---
          
          #### Method 2: Right-Click to Open
          
          1. Install DMG ‚Üí Drag to Applications
          2. **Right-click (or Ctrl+Click)** ArgoLogViewer ‚Üí Select **"Open"**
          3. Click **"Open"** again in the dialog
          4. ‚úÖ Done!
          
          **‚ö†Ô∏è Note:** This method may not work on macOS Sequoia (15.x). If it doesn't work, use Method 1 instead.
          
          ---
          
          #### Method 3: Terminal Command (Advanced)
          
          1. Install DMG or unzip ZIP to Applications
          2. Open Terminal and run:
             ```bash
             xattr -cr /Applications/ArgoLogViewer.app
             ```
          3. Open the app normally (or right-click ‚Üí Open if needed)
          
          **For macOS Sequoia (15.x)**, if the above doesn't work, also run:
          ```bash
          sudo codesign --remove-signature /Applications/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer
          sudo codesign -s - --deep --force /Applications/ArgoLogViewer.app
          ```
          
          ---
          
          ### üìñ NEED MORE HELP?
          
          **üëâ See the complete installation guide with screenshots:**  
          [MACOS_INSTALLATION.md](../../blob/main/MACOS_INSTALLATION.md)
          
          ---
          
          ### ‚úÖ Compatibility
          
          - **macOS 11.0 Big Sur** and later
          - **macOS 12.0 Monterey** ‚úÖ
          - **macOS 13.0 Ventura** ‚úÖ
          - **macOS 14.0 Sonoma** ‚úÖ
          - **macOS 15.0 Sequoia** ‚úÖ
          
          ### üõ°Ô∏è Is This Safe?
          
          **Yes!** Here's why:
          - ‚úÖ **Open Source**: Full source code on GitHub
          - ‚úÖ **Checksums Provided**: Verify downloads haven't been tampered with
          - ‚úÖ **Read-Only Operations**: Only views logs, doesn't modify anything
          - ‚úÖ **No Malware**: Clean, safe code
          
          **Why the warning?** Apple requires developers to:
          - Pay $99/year for code signing certificates
          - Submit apps for notarization (48-72 hour review)
          - This is a free, open-source project without those resources
          
          Many free macOS apps are distributed this way.
          
          ---
          
          ### ‚úÖ Checksums (SHA-256)
          
          See `CHECKSUMS.txt` for SHA-256 verification of downloads.
          
          ### üêõ Issues?
          
          Report at: https://github.com/${{ github.repository }}/issues
        draft: false
        prerelease: false
        files: |
          ArgoLogViewer-macOS-AppleSilicon-v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.dmg
          ArgoLogViewer-macOS-AppleSilicon-v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS-AppleSilicon.zip
          CHECKSUMS.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
