name: Build All Platforms

on:
  workflow_dispatch:  # MANUAL TRIGGER ONLY - You click a button, no auto-runs
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --name="ArgoLogViewer" `
          --onefile `
          --windowed `
          --add-data="app;app" `
          --hidden-import=PySide6 `
          --hidden-import=paramiko `
          --hidden-import=cryptography `
          --icon=app/icon.ico `
          --clean `
          app/main.py
    
    - name: Rename with version
      run: |
        Copy-Item "dist\ArgoLogViewer.exe" "ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe"
    
    - name: Generate checksum
      run: |
        $hash = Get-FileHash -Algorithm SHA256 "ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe"
        "$($hash.Hash)  ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe" | Out-File -Encoding ASCII checksums-windows.txt
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: ArgoLogViewer-Windows
        path: |
          ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe
          checksums-windows.txt

  build-macos:
    # Build universal2 binary (Intel + Apple Silicon) using Python.org's universal2 Python
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Python.org universal2 Python
      run: |
        echo "üì¶ Downloading Python.org universal2 Python installer..."
        curl -o python-installer.pkg https://www.python.org/ftp/python/3.11.7/python-3.11.7-macos11.pkg
        
        echo "üîß Installing Python..."
        sudo installer -pkg python-installer.pkg -target /
        
        # Use the Python.org Python (not system Python)
        export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH"
        
        echo "‚úÖ Python installed:"
        python3.11 --version
        
        # Verify it's universal2
        echo "üîç Verifying Python is universal2..."
        lipo -info /Library/Frameworks/Python.framework/Versions/3.11/Python
        
        if lipo -info /Library/Frameworks/Python.framework/Versions/3.11/Python | grep -q "x86_64" && lipo -info /Library/Frameworks/Python.framework/Versions/3.11/Python | grep -q "arm64"; then
          echo "‚úÖ Python is universal2 (x86_64 + arm64)"
        else
          echo "‚ùå ERROR: Python is not universal2!"
          exit 1
        fi
    
    - name: Install dependencies
      run: |
        # Use Python.org Python
        export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH"
        
        echo "üì¶ Installing pip packages..."
        python3.11 -m pip install --upgrade pip
        python3.11 -m pip install -r requirements.txt
        python3.11 -m pip install pyinstaller
        
        echo "‚úÖ Dependencies installed"
    
    - name: Build macOS universal2 app
      run: |
        # Use Python.org Python
        export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH"
        export MACOSX_DEPLOYMENT_TARGET=11.0
        
        echo "üî® Building universal2 app with PyInstaller..."
        echo "üìã Deployment target: macOS 11.0 Big Sur and later"
        python3.11 -m PyInstaller --name="ArgoLogViewer" \
          --windowed \
          --onefile \
          --add-data="app:app" \
          --hidden-import=PySide6 \
          --hidden-import=paramiko \
          --hidden-import=cryptography \
          --clean \
          --osx-bundle-identifier=com.harshmeetsingh.argologviewer \
          --target-arch universal2 \
          --codesign-identity - \
          app/main.py
    
    - name: Verify universal2 binary
      run: |
        echo "üîç Verifying universal2 build..."
        echo ""
        
        # Find the main executable inside the .app bundle
        EXECUTABLE="dist/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer"
        
        if [ ! -f "$EXECUTABLE" ]; then
          echo "‚ùå ERROR: Executable not found at $EXECUTABLE"
          exit 1
        fi
        
        echo "üì¶ Checking architectures:"
        lipo -info "$EXECUTABLE"
        echo ""
        
        # Verify it contains both architectures
        if lipo -info "$EXECUTABLE" | grep -q "x86_64" && lipo -info "$EXECUTABLE" | grep -q "arm64"; then
          echo "‚úÖ SUCCESS: Binary is universal2!"
          echo "   ‚úì Contains x86_64 (Intel)"
          echo "   ‚úì Contains arm64 (Apple Silicon)"
          echo "‚úÖ NO Rosetta 2 required!"
        else
          echo "‚ùå ERROR: Binary is not universal2!"
          exit 1
        fi
    
    - name: Create DMG
      run: |
        mkdir -p dist/dmg
        cp -r dist/ArgoLogViewer.app dist/dmg/
        ln -s /Applications dist/dmg/Applications
        hdiutil create -volname "Argo Log Viewer" \
          -srcfolder dist/dmg \
          -ov -format UDZO \
          "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg"
    
    - name: Zip .app
      run: |
        cd dist
        zip -r ../ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip ArgoLogViewer.app
        cd ..
    
    - name: Generate checksums
      run: |
        shasum -a 256 ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg > checksums-macos.txt
        shasum -a 256 ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip >> checksums-macos.txt
    
    - name: Final verification
      run: |
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "‚úÖ macOS BUILD COMPLETE - UNIVERSAL2"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        
        # Verify the final DMG
        echo "üîç Final verification of DMG contents..."
        hdiutil attach "ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg" -mountpoint /tmp/verify_dmg
        
        DMG_EXECUTABLE="/tmp/verify_dmg/ArgoLogViewer.app/Contents/MacOS/ArgoLogViewer"
        if [ -f "$DMG_EXECUTABLE" ]; then
          echo "‚úÖ DMG mounted successfully"
          echo "üìã Architecture check:"
          lipo -info "$DMG_EXECUTABLE"
          
          if lipo -info "$DMG_EXECUTABLE" | grep -q "x86_64" && lipo -info "$DMG_EXECUTABLE" | grep -q "arm64"; then
            echo "‚úÖ DMG contains universal2 binary (x86_64 + arm64)"
            echo "‚úÖ ONE-CLICK INSTALL - NO ROSETTA 2 REQUIRED!"
          else
            echo "‚ùå ERROR: DMG does not contain universal2 binary!"
            exit 1
          fi
        else
          echo "‚ùå ERROR: Could not verify DMG contents"
          exit 1
        fi
        
        hdiutil detach /tmp/verify_dmg || true
        echo ""
        echo "‚úÖ Native support for Intel and Apple Silicon Macs"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ArgoLogViewer-macOS
        path: |
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg
          ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip
          checksums-macos.txt

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Linux binary
      run: |
        pyinstaller --name="ArgoLogViewer" \
          --onefile \
          --add-data="app:app" \
          --hidden-import=PySide6 \
          --hidden-import=paramiko \
          --hidden-import=cryptography \
          --clean \
          app/main.py
    
    - name: Rename and make executable
      run: |
        mv dist/ArgoLogViewer ArgoLogViewer-v${{ github.event.inputs.version }}-Linux
        chmod +x ArgoLogViewer-v${{ github.event.inputs.version }}-Linux
    
    - name: Generate checksum
      run: |
        sha256sum ArgoLogViewer-v${{ github.event.inputs.version }}-Linux > checksums-linux.txt
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ArgoLogViewer-Linux
        path: |
          ArgoLogViewer-v${{ github.event.inputs.version }}-Linux
          checksums-linux.txt

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Combine checksums
      run: |
        cat ArgoLogViewer-Windows/checksums-windows.txt > CHECKSUMS.txt
        cat ArgoLogViewer-macOS/checksums-macos.txt >> CHECKSUMS.txt
        cat ArgoLogViewer-Linux/checksums-linux.txt >> CHECKSUMS.txt
        echo "=== CHECKSUMS ==="
        cat CHECKSUMS.txt
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Argo Log Viewer v${{ github.event.inputs.version }}
        body: |
          ## üöÄ Argo Log Viewer v${{ github.event.inputs.version }}
          
          Professional desktop application for viewing Argo Workflow logs via SSH.
          
          ### üì• Downloads
          
          Choose the version for your operating system:
          
          | Platform | Download | Size |
          |----------|----------|------|
          | ü™ü **Windows** | [ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe) | ~50 MB |
          | üçé **macOS (DMG)** - Universal2 | [ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg) | ~80 MB |
          | üçé **macOS (ZIP)** - Universal2 | [ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip) | ~80 MB |
          | üêß **Linux** | [ArgoLogViewer-v${{ github.event.inputs.version }}-Linux](../../releases/download/v${{ github.event.inputs.version }}/ArgoLogViewer-v${{ github.event.inputs.version }}-Linux) | ~70 MB |
          
          > üçé **macOS Note:** Universal2 binary with native support for both Intel (x86_64) and Apple Silicon (arm64). **One-click install, no Rosetta 2 required!**
          
          ### üìã Installation Instructions
          
          #### Windows
          1. Download `ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe`
          2. Double-click to run
          3. Windows Defender may warn you - click "More info" ‚Üí "Run anyway"
          
          #### macOS (DMG - Recommended)
          1. Download `ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg`
          2. Open the DMG file
          3. Drag "ArgoLogViewer" to Applications folder
          4. Right-click app ‚Üí Open (first time only)
          
          #### macOS (ZIP)
          1. Download and unzip
          2. Move to Applications folder
          3. Run: `xattr -cr /Applications/ArgoLogViewer.app`
          4. Double-click to open
          
          #### Linux
          1. Download `ArgoLogViewer-v${{ github.event.inputs.version }}-Linux`
          2. Make executable: `chmod +x ArgoLogViewer-v${{ github.event.inputs.version }}-Linux`
          3. Run: `./ArgoLogViewer-v${{ github.event.inputs.version }}-Linux`
          
          ### ‚úÖ Verify Download (SHA-256)
          
          See `CHECKSUMS.txt` for SHA-256 hashes to verify your download.
          
          ### üÜï What's New in v${{ github.event.inputs.version }}
          
          - Initial release with production-grade build system
          - Cross-platform support (Windows, macOS, Linux)
          - Professional installers for all platforms
          
          ### üêõ Found a Bug?
          
          Report issues at: https://github.com/${{ github.repository }}/issues
          
          ### üìñ Documentation
          
          - [README](../../blob/main/README.md)
          - [Build Instructions](../../blob/main/BUILD.md)
          
          ---
          
          **Built with:** Python, PySide6, PyInstaller
          **License:** See [LICENSE.txt](../../blob/main/LICENSE.txt)
        draft: false
        prerelease: false
        files: |
          ArgoLogViewer-Windows/ArgoLogViewer-v${{ github.event.inputs.version }}-Windows.exe
          ArgoLogViewer-macOS/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.dmg
          ArgoLogViewer-macOS/ArgoLogViewer-v${{ github.event.inputs.version }}-macOS.zip
          ArgoLogViewer-Linux/ArgoLogViewer-v${{ github.event.inputs.version }}-Linux
          CHECKSUMS.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
